<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Cashier Game</title>
	<script language="javascript"  src="easel.js"></script>
	<script language="javascript"  src="jquery.js"></script>
	<script language="javascript"  src="SoundJS.js"></script>
	<script language="javascript"  src="preload.js"></script>
	<script language="javascript"  src="FlashPlugin.js"></script>
	<script language="javascript"  src="Item.js"></script>
	<script language="javascript"  src="BagSlot.js"></script>
	<script language="javascript"  src="layout.js"></script>
	<script type="text/javascript">

	
	
	
		//Variables
        var canvas;
        var stage;
        var img;
		var items, itembuffer, numitems, itemlibrary;
		var images;
		var manifest;
		var conveyorMoving;
		var selectedItem;
		var offset;
		var loader;
		var grid1;
		var grid2;
		var score, scoretext;
		
		
    function init() {
			canvas = document.getElementById("canvas");
			stage = new Stage(canvas);
			initConstants();
			titleScreen();
    }
		
		
	
	
	function createItemPool(){
		numitems = 0;
		for (var i = 0; i < itembuffer.length; i++){
			numitems += itembuffer[i].count;
		}
	}
	
	
	function importItemLibrary(){
		itemlibrary = new Array();
		$.getJSON('itemlibrary.json', function(data) {
			$.each(data, function(key, val) {
				itemlibrary.push(val);
			});
					
		});
	}
	
	function handlePlayPress(){
			stage.removeAllChildren();

			images = [];
			conveyorMoving = true;
			score = 0;
			
			itembuffer = new Array();
			// Get the JSON Objects out of the json file.
				$.getJSON('levels.json', function(data) {
				  $.each(data, function(key, val) {
					itembuffer.push(val);
				  });
				  createItemPool();
				});
			
			itemlibrary = new Array();
				$.getJSON('itemlibrary.json', function(data) {
				  $.each(data, function(key, val) {
					itemlibrary.push(val);
				  });
				  //Executed once library is full
					
				});
			
			
				
			SoundJS.FlashPlugin.BASE_PATH = "assets/" // Initialize the base path from this document to the Flash Plugin
		
			if (!SoundJS.checkPlugin(true)) {
				return;
			}	
			
			
			var assetsPath = "assets/";
			manifest = [
						{src:assetsPath+"BlackBall.png", id:"ball0"},
						{src:assetsPath+"WhiteBall.png", id:"ball1"},
						{src:assetsPath+"18-machinae_supremacy-lord_krutors_dominion.mp3|"+assetsPath+"18-machinae_supremacy-lord_krutors_dominion.ogg", id:"music"},
						{src:assetsPath+"GU-StealDaisy.mp3|"+assetsPath+"GU-StealDaisy.ogg", id:"boink"}
				]	
		
			
			setGrids();
			
			stage.onMouseUp = handleMouseUp;
			
			loader = new PreloadJS();
			loader.installPlugin(SoundJS);
			loader.onFileLoad = handleFileLoad;
			loader.onFileError = handleFileError;
			loader.onComplete = handleComplete;
			loader.onProgress = handleProgress;
			loader.loadManifest(manifest);
			//loader.loadFile(item, true);
			
			
	}
	
	
	
	
	function checkConveyor(){
	
		var blocked = false;
		for(var i=0;i<items.length;i++) {
				var item = items[i];
				if (item === selectedItem){
					
				}
				else if (item.x < canvas.width * .60 + item.radius 
								&& item.x > canvas.width* .60
								&& item.y < canvas.height * .9 
								&& item.y > canvas.height * .65){
					blocked = true;
					}

			}
		if (blocked == true) 
			conveyorMoving = false;
		else 
			conveyorMoving = true;
	
	}
	
	
	function handleItemMove(event){
			selectedItem.x = event.stageX+offset.x;
			selectedItem.y = event.stageY+offset.y;
			if (selectedItem.x > SCANNER_X && selectedItem.x < SCANNER_X + SCANNER_WIDTH &&
				selectedItem.y > SCANNER_Y && selectedItem.y < SCANNER_Y + SCANNER_HEIGHT){
				console.log("Item Scanned!");
				selectedItem.changeState(loader.getResult(manifest[1].id));
				//selectedItem.source =  loader.getResult(manifest[1].id);
			}
	}
	
	function checkBagCollisions(item){
		for(var i = 0; i < 3; i++){
				for(var j = 0; j<3; j++){
					if (item.x > grid1[i][j].x &&
						item.y > grid1[i][j].y &&
						item.x < grid1[i][j].x + grid1[i][j].width &&
						item.y < grid1[i][j].y + grid1[i][j].height){
							score+= 100;
							item.x = grid1[i][j].x + grid1[i][j].width/2;
							item.y = grid1[i][j].y + grid1[i][j].height/2;
						}
					else if (item.x > grid2[i][j].x &&
						item.y > grid2[i][j].y &&
						item.x < grid2[i][j].x + grid2[i][j].width &&
						item.y < grid2[i][j].y + grid2[i][j].height){
							score+= 100;
							item.x = grid2[i][j].x + grid2[i][j].width/2;
							item.y = grid2[i][j].y + grid2[i][j].height/2;
						}
				}
			}
	
	
	}
	
	function handleMouseUp(){
		if (selectedItem != null){
			//Check to make sure its not just being moved on the conveyor belt
			
			//See if its in the bounds of bag 1
			if (selectedItem.x > BAG_1_X && selectedItem.x < BAG_1_X + BAG_WIDTH){
				console.log("Between bag 1");
				checkBagCollisions(selectedItem);
			}
			//See if its in the bounds of bag 2
			else if (selectedItem.x > BAG_2_X && selectedItem.x < BAG_2_X + BAG_WIDTH){
				console.log("Between bag 2");
				checkBagCollisions(selectedItem);
			} 
			else if (selectedItem.x > CONVEYOR_X && selectedItem.y > CONVEYOR_Y && selectedItem.x < CONVEYOR_X+CONVEYOR_WIDTH && selectedItem.y < CONVEYOR_Y+CONVEYOR_HEIGHT){
				console.log("Item is on the conveyor belt");
			}
			else{
				selectedItem.x = selectedItem.oldx;
				selectedItem.y = selectedItem.oldy;
			}
			selectedItem = null;
			
		}
		
	
	}
	
	
	
	function handleItemPress(event){
		//Play a sound
		SoundJS.play("boink", SoundJS.INTERRUPT_ANY, 0 , 0 , 0 , 1 , 0 );
		var item = event.target;
		selectedItem = item;
		item.oldx = item.x;
		item.oldy = item.y;
		offset = {x:item.x-event.stageX, y:item.y-event.stageY};
		event.onMouseMove = handleItemMove;
	    
	}
	
	function handleItemMouseOver(){
	//Make the item look larger
	    this.scale = .7;
	    this.scaleX = this.scaleY = this.scale;
	}
	
	function handleItemMouseOut(){
	//Bring the item back to normal
	    this.scale = .5;
	    this.scaleX = this.scaleY = this.scale;
	}
	
	function addItem(){
	   // var item = new Item(loader.getResult(manifest[parseInt(Math.random()*2)].id));
	   var item = new Item(loader.getResult(manifest[0].id));
        item.scale = .5;
		item.scaleX = item.scaleY = item.scale;
	    
		item.vx = Math.random()*25-15;
		item.vy = Math.random()*35-15;
		item.regX = item.regY = 35;
		item.bounce = -0.7//-Math.random()*1-0.7;

		item.onPress = handleItemPress;
		item.onMouseOver = handleItemMouseOver;
		item.onMouseOut = handleItemMouseOut;

		item.x = canvas.width+item.radius*3*item.scale - 200;//Math.random()*canvas.width;
	    item.y = Math.random()*canvas.height * .25 + canvas.height * .65;
	    item.oldX = item.oldY = 0;
	
		items.push(item);

		
		stage.addChild(item);

	}
	
	function playSound(name, loop) {
		// Play the sound using the ID created above.
		return SoundJS.play(name);
	}
	
	function handleComplete() {
	
	    drawLayout();
            items = [];
		//	SoundJS.play("music", SoundJS.INTERRUPT_NONE, 0 , 0 , -1 , 1 , 0 );
			playSound("music");
			
			//This adds the background
          //  addBG(loader.getResult('bg').result);
			
	//This adds the initial balls.
            for(var i=0;i<images.length;i++) {
				addItem();
            }
	    
            run();
        }
	
	function handleFileLoad(event) {
		if (event.id == "music"){
			console.log("Loaded music!");
			return;
		}
            images.push(event)
		 console.log("Loaded a file");
        }
		
	function handleFileError(event){
		console.log("File Error!");
	
	}
	
	function handleProgress(event){
	
	}
	
	function run(){
		
		stage.enableMouseOver();
		Ticker.addListener(window);
		Ticker.setInterval(17);
		stage.update();
		
	}
	
	function moveConveyorBelt(){
		var total = items.length;
		for(var i=0;i<total;i++) {
			var item = items[i];
			if (item.x > canvas.width * .59 && item.y < canvas.height * .9  && item.y > canvas.height * .65 && item !== selectedItem){
				if (conveyorMoving){
					item.x = item.x - 1;
				}
			}
			else if(item.y < BAG_SECTION_Y+BAG_HEIGHT && item != selectedItem){
				item.y = item.y +1
			}
			
		}
	}
	
	function tick(){ 
		var total = items.length;
		
		
		//Add Items every 100 ticks
		if (Ticker.getTicks() % 100 == 0 && numitems >= 0){
			addItem();
			numitems--;
		}
		
		
		moveConveyorBelt();
		checkConveyor();
		updateScore();
		stage.update(); 
	}

	

    </script>
</head>
<body onload="init();">


	<div class="canvasHolder">
	  <!---  <canvas id="canvas" width="1280" height="768" style="border:5px solid #aaaaaa;"></canvas>-->
	 <canvas id="canvas" width="1280" height="768" style="border:5px solid #aaaaaa;"></canvas>
	  </div>

</body>
</html>